<script>
  // --- 1. ตั้งค่า Flatpickr ---
  const fp = flatpickr("#datePicker", {
    locale: "th", dateFormat: "Y-m-d", altInput: true, altFormat: "d/m/Y",
    defaultDate: new Date(), disableMobile: "true"
  });

  // --- 2. ฟังก์ชันสลับหน้า ---
  function switchPage(pageId, navElement) {
    document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    navElement.classList.add('active');

    if(pageId === 'page-stats') {
      loadDashboard();
    }
  }

  // --- 3. ฟังก์ชันบันทึกข้อมูล ---
  function handleFormSubmit(formObject) {
    event.preventDefault();
    const btn = document.querySelector('.btn-save');
    const originalText = btn.innerText;
    btn.innerText = 'กำลังบันทึก... ⏳'; btn.disabled = true;

    google.script.run.withSuccessHandler(function(response) {
        const msg = document.getElementById('message');
        msg.innerText = response; msg.style.display = 'block';
        formObject.reset(); fp.setDate(new Date());
        btn.innerText = originalText; btn.disabled = false;
        setTimeout(() => { msg.style.display = 'none'; }, 3000);
      }).saveData(formObject);
  }

  // --- 4. ฟังก์ชันโหลดและคำนวณ Dashboard ---
  let myChart = null;

  function loadDashboard() {
    document.getElementById('recentList').innerHTML = '<li class="list-group-item text-center">กำลังโหลด...</li>';
    google.script.run.withSuccessHandler(renderDashboard).getDataForDashboard();
  }

  function renderDashboard(data) {
    if (!data || data.length === 0) {
       document.getElementById('recentList').innerHTML = '<li class="list-group-item text-center text-muted">ยังไม่มีข้อมูลรายการ</li>';
       return;
    }

    let income = 0;
    let expense = 0;
    let categories = {};
    let recentHtml = '';
    const limit = 5; 
    let count = 0;

    for (let i = data.length - 1; i >= 0; i--) {
        let row = data[i];
        if (!row[0] || row[4] === "") continue;

        let type = row[1];
        let cat = row[2];
        let amount = parseFloat(String(row[4]).replace(/,/g, ''));
        if (isNaN(amount)) amount = 0;

        if (type === 'รายรับ') {
            income += amount;
            // รวมยอดรายรับเข้ากราฟด้วย
            if (categories[cat]) { categories[cat] += amount; } 
            else { categories[cat] = amount; }
        } else if (type === 'รายจ่าย') {
            expense += amount;
            if (categories[cat]) { categories[cat] += amount; } 
            else { categories[cat] = amount; }
        }

        if (count < limit) {
            let colorClass = type === 'รายรับ' ? 'text-success' : 'text-danger';
            let sign = type === 'รายรับ' ? '+' : '-';
            // ปรับสี Text ให้เข้มขึ้น
            let amountColor = type === 'รายรับ' ? '#4ECDC4' : '#FF6B6B';
            
            recentHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <span class="badge bg-light text-dark border">${row[0]}</span> 
                <span class="ms-1" style="font-weight:500;">${cat}</span>
                <div class="text-muted" style="font-size:0.8rem; margin-left: 5px;">${row[3]}</div>
              </div>
              <span style="color:${amountColor}; font-weight:700;">${sign}${amount.toLocaleString()}</span>
            </li>`;
            count++;
        }
    }

    document.getElementById('totalIncome').innerText = income.toLocaleString();
    document.getElementById('totalExpense').innerText = expense.toLocaleString();
    document.getElementById('totalBalance').innerText = (income - expense).toLocaleString();
    document.getElementById('recentList').innerHTML = recentHtml || '<li class="list-group-item text-center">ยังไม่มีข้อมูล</li>';

    if (income > 0 || expense > 0) {
        renderChart(categories);
    } else {
        if (myChart) { myChart.destroy(); }
    }
  }

  function renderChart(categories) {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const labels = Object.keys(categories);
    const values = Object.values(categories);
    
    // --- ตั้งค่าสี Vibrant Pastel (เข้มขึ้น สดขึ้น) ---
    const colorMap = {
      'รายได้': '#4ECDC4' // สีเขียวมิ้นต์เข้ม
    };
    
    // ชุดสีสำรองที่สดใสขึ้น (แดง, ม่วง, เหลือง, ส้ม)
    const fallbackColors = ['#FF6B6B', '#A18CD1', '#FFD93D', '#FF8E72', '#6BCB77', '#4D96FF'];

    let finalColors = labels.map((labelName, index) => {
       if (colorMap[labelName]) return colorMap[labelName];
       return fallbackColors[index % fallbackColors.length];
    });

    if (myChart) { myChart.destroy(); }

    myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: finalColors,
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverOffset: 15 // เวลาเอาเมาส์ชี้ ชิ้นกราฟจะเด้งออกมาเยอะๆ
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                animateScale: true, // กราฟเด้งขึ้นมาตอนโหลด
                animateRotate: true
            },
            plugins: {
                legend: { position: 'right', labels: { font: { family: 'Kanit', size: 12 }, boxWidth: 15 } },
                tooltip: {
                  backgroundColor: 'rgba(0,0,0,0.8)',
                  padding: 12,
                  bodyFont: { family: 'Kanit' },
                  callbacks: {
                    label: function(context) {
                       let label = context.label || '';
                       if (label) { label += ': '; }
                       label += context.parsed.toLocaleString() + ' บาท';
                       return label;
                    }
                  }
                }
            }
        }
    });
  }
</script>
